const axios = require("axios");
const bwipjs = require("bwip-js");
var html_to_pdf = require("html-pdf-node");
const QRCode = require("qrcode");
var fs = require("fs");
const Delhivery = require("../../integrations/courierPartners/delhivery.js");
const { updateJobStatus, updateOrderStatus } = require("../../utils/db.js");
const CustomError = require("../../utils/customError");
const { Order } = require("../../models");
async function createShipment(order, job = null) {
  try {
    if (!order.orderId) throw new CustomError(400, "Order Id is required");
    updateOrderStatus(order.orderId, "processing");
    const accessToken = "ad0909fbe983d4c0e26bfa49051a9dbfc7d8bb81";
    const URL = "https://staging-express.delhivery.com";
    const delhiveryCourier = new Delhivery(accessToken, URL);
    let wayBillNumber = await delhiveryCourier.initiateBooking();
    let randomNumber = Math.random();
    var awbFilePath = `awbLabel_${randomNumber}_${randomNumber}.pdf`;
    let generateShippingLabel = await createShippingLabel(wayBillNumber, awbFilePath);
    let filePath = "";
    if (generateShippingLabel.isCreated) {
      filePath = generateShippingLabel.shippingLabelFilePath;
    }
    if (!job) return filePath;
    else {
      updateJobStatus(job, "completedOrders");
      updateOrderStatus(order.orderId, "booked");
    }
  } catch (err) {
    console.log("error in createShipment service...", err);
    if (job) {
      updateJobStatus(job, "failedOrders");
      updateOrderStatus(order.orderId, "failed");
    } else {
      throw new CustomError(500, "Error in createShipment service");
    }
  }
}

async function wayBillGeneration() {
  let config = {
    method: "get",
    maxBodyLength: Infinity,
    url: "https://staging-express.delhivery.com/waybill/api/fetch/json/",
    headers: {
      Authorization: "Token ad0909fbe983d4c0e26bfa49051a9dbfc7d8bb81",
      Cookie: "sessionid=br7sthmpnh5lcoow4gd0sebdkbtxuz4q",
    },
  };

  let wayBillResponse = await axios
    .request(config)
    .then((response) => {
      const awbNumber = response.data || "";
      return awbNumber || "";
    })
    .catch((error) => {
      console.log("error", error);
      return null;
    });
  console.log({ wayBillResponse });
  return wayBillResponse;
}
async function createShippingLabel(stNumber, shippingLabelFilePath) {
  let order = {};
  let awbNumber = stNumber || "";
  let orderId = order.name || "12341234";

  let barcodeDataUrl = "";
  let qrDataUrl = "";
  barcodeDataUrl = await generateBarcode(awbNumber);
  if (barcodeDataUrl.error) {
    return {
      isBooked: false,
      orderId,
    };
  }

  qrDataUrl = await createQRCode(orderId);

  let html = `
  <html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      body {
        border: 1px solid black;
        margin: 10px;
        padding: 0;
        font-family: arial, sans-serif;
        border-radius: 10px;
      }
      h4 {
          font-family: 'Mali', sans-serif;
      }
      .header-style {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: 60px;
        border-bottom: 1px solid black !important;
      }
      .address-details {
        flex: 1;
        padding: 0 5px;
        height: fit-content;
        border-bottom: 1px solid black;
      }

      .shipping-address {
        flex: 1;
        padding: 0 5px;
        height: fit-content;
        border-bottom: 1px solid black;
      }
      .bill-value {
        position: relative;
        align-items: center;
        flex: 1;
        padding: 0 5px;
        height: fit-content;
        height: 30px;
        border-bottom: 1px solid black;
      }
      .barcode-details {
        position: relative;
        align-items: center;
        flex: 1;
        height: fit-content;
        border-bottom: 1px solid black;
      }
      .footer {
        display: flex;
        align-content: center !important;
        justify-content: space-between;
        height: fit-content;
      }
      .cls-1 {
        fill: #aca9f0;
        stroke: #3c1277;
      }
    
      .cls-1, .cls-2, .cls-3, .cls-4, .cls-5 {
        stroke-width: .29px;
      }
    
      .cls-1, .cls-2, .cls-4, .cls-5 {
        stroke-linecap: round;
        stroke-linejoin: round;
      }
    
      .cls-2 {
        fill: #3cc1cd;
        stroke: #13888e;
      }
    
      .cls-3 {
        fill: #2ad39b;
        stroke: #167251;
        stroke-miterlimit: 10;
      }
    
      .cls-4 {
        fill: #f7b213;
        stroke: #9e6808;
      }
    
      .cls-5 {
        fill: #ed3852;
        stroke: #9e122d;
      }
      .address-inline {
        margin: 2px;
      }
    </style>
  </head>
  <body>
    <section>
      <!-- <section> -->
      <div style="height: 100%;">
        <div
        class="header-style"
        >
        <div>
          <p style="text-align: center; font-size: 16px; margin-left: 5px"><b>DELHIVERY</b></p>
          </div>
          <div style="margin-bottom: 6px">
          <svg xmlns="http://www.w3.org/2000/svg" width="86" height="30" viewBox="0 0 865 351" fill="none">
            <path d="M77.6057 350.165C67.0862 350.421 56.6617 348.12 47.228 343.458C37.3609 338.395 28.9615 330.88 22.8368 321.635C6.2178 294.913 -1.66224 263.677 0.292464 232.27C-1.35795 202.99 7.21297 174.046 24.5398 150.385C31.6522 141.192 40.8405 133.814 51.3528 128.855C61.865 123.896 73.4024 121.497 85.0201 121.854C95.3355 121.808 105.506 124.278 114.652 129.048C123.798 133.819 131.644 140.747 137.51 149.232C153.002 172.895 160.504 200.9 158.914 229.139C160.559 261.076 151.858 292.692 134.104 319.29C127.902 328.638 119.517 336.335 109.673 341.714C99.8287 347.094 88.8225 349.995 77.6057 350.165ZM103.805 151.892C97.3706 147.273 89.6106 144.869 81.6925 145.041C73.4589 144.976 65.4005 147.415 58.5853 152.036C51.2905 157.089 45.2826 163.783 41.0448 171.58C30.3055 192.894 25.2905 216.633 26.4914 240.47C24.8918 262.902 29.7418 285.324 40.4688 305.09C44.3363 311.525 49.821 316.834 56.3778 320.491C62.9346 324.147 70.3347 326.023 77.8416 325.932C86.8031 325.554 95.4606 322.575 102.756 317.357C110.052 312.139 115.669 304.908 118.921 296.549C128.617 276.475 133.314 254.355 132.61 232.073C132.61 192.897 123.004 166.174 103.791 151.904L103.805 151.892Z" fill="#202020"/>
            <path d="M593.013 142.08C593.227 144.265 592.993 146.471 592.324 148.563C591.655 150.655 590.566 152.588 589.124 154.244C587.681 155.9 585.916 157.243 583.936 158.193C581.955 159.142 579.802 159.677 577.608 159.764C560.308 165.605 545.382 176.922 535.087 192.002C519.81 209 509.906 230.14 506.622 252.758C505.853 261.491 505.474 269.477 505.483 276.716C505.483 294.034 506.242 312.194 507.762 331.197C508.125 333.777 507.889 336.406 507.071 338.88C506.253 341.355 504.876 343.607 503.046 345.462C500.01 348.489 495.922 350.225 491.636 350.309C489.647 350.325 487.675 349.941 485.836 349.181C483.998 348.42 482.331 347.298 480.934 345.882C479.33 344.082 478.161 341.937 477.518 339.614C476.875 337.29 476.776 334.849 477.227 332.481C477.794 326.49 478.271 319.552 478.655 311.666C479.039 303.78 479.419 295.458 479.795 286.698C480.17 271.852 480.358 255.308 480.358 237.064C480.358 206.255 479.978 183.382 479.218 168.449C478.247 159.868 478.344 151.2 479.506 142.643C480.306 140.57 481.575 138.709 483.213 137.207C486.041 134.345 489.88 132.707 493.903 132.648C497.842 132.666 501.623 134.2 504.461 136.932C505.992 138.292 507.178 139.997 507.923 141.905C508.667 143.814 508.949 145.871 508.744 147.909C508.456 152.389 508.076 156.756 507.605 161.009C507.133 165.261 506.609 170.536 506.033 176.833C504.889 186.911 503.845 197.657 502.902 209.071C510.853 189.23 522.142 170.897 536.279 154.865C552.444 136.805 566.517 127.771 578.499 127.763C580.557 127.568 582.633 127.853 584.563 128.596C586.493 129.34 588.224 130.52 589.62 132.046C591.893 134.889 593.094 138.441 593.013 142.08Z" fill="#202020"/>
            <path d="M668.948 92.0536C668.568 115.266 668.228 100.189 667.952 127.187C667.677 154.185 667.52 130.016 667.52 186.317C667.52 242.619 668.28 282.886 669.8 330.804C670.075 333.357 669.825 335.94 669.066 338.393C668.307 340.846 667.054 343.119 665.385 345.07C663.945 346.618 662.199 347.849 660.257 348.683C658.315 349.518 656.22 349.938 654.106 349.917C649.793 349.941 645.625 348.363 642.408 345.489C638.985 342.546 637.557 335.843 638.125 325.381C638.693 314.919 639.313 299.2 639.985 278.223C640.653 257.264 641.295 246.273 641.845 221.738C642.788 167.729 643.273 188.335 643.273 151.918C643.273 115.502 643.273 128.339 643.129 110.078C642.985 91.8176 642.893 91.4773 642.71 76.0199C642.33 47.1094 641.4 43.0879 639.854 19.1159C639.173 14.1017 640.511 9.02238 643.574 4.99458C644.886 3.39525 646.544 2.115 648.423 1.25039C650.302 0.385775 652.353 -0.041137 654.421 0.00312147C658.947 0.0668703 663.279 1.8519 666.538 4.99458C668.711 7.76444 670.279 10.9596 671.138 14.3738C671.998 17.7881 672.131 21.3452 671.529 24.8141C671.149 34.7042 670.716 32.5817 670.219 51.4056C669.721 70.2296 669.328 68.8414 668.948 92.0536Z" fill="#202020"/>
            <path d="M850.857 349.864C839.443 349.864 833.736 341.21 833.736 323.901C833.736 322.766 833.64 319.53 833.448 314.194C831.701 316.29 829.797 318.57 827.736 321.033C821.125 329.691 812.691 336.789 803.032 341.826C793.373 346.863 782.724 349.714 771.841 350.179C764.45 350.415 757.086 349.173 750.181 346.528C743.276 343.883 736.967 339.887 731.625 334.773C726.166 329.51 721.872 323.16 719.02 316.134C716.168 309.108 714.821 301.561 715.068 293.982C714.778 283.243 717.06 272.59 721.725 262.912C726.389 253.234 733.301 244.812 741.882 238.349C749.956 232.032 759.089 227.202 768.854 224.083C779.702 220.726 791.008 219.09 802.363 219.237C812.661 219.245 822.885 220.98 832.609 224.371V194.124C833.598 180.748 829.918 167.443 822.195 156.477C819.772 152.905 816.578 149.923 812.849 147.751C809.119 145.579 804.949 144.272 800.647 143.927C794.481 143.713 788.331 144.682 782.53 146.783C777.881 148.682 773.662 151.497 770.125 155.062C762.175 162.773 757.304 173.115 756.423 184.156C756.942 186.412 756.874 188.764 756.225 190.986C755.576 193.209 754.368 195.227 752.716 196.849C749.896 199.148 746.371 200.407 742.734 200.413C732.464 200.413 727.517 193.566 727.892 179.873C728.448 172.132 730.675 164.603 734.42 157.805C738.165 151.007 743.339 145.102 749.585 140.495C762.912 128.565 780.166 121.963 798.053 121.947C810.22 121.394 822.208 125.028 832.02 132.243C841.831 139.459 848.873 149.82 851.97 161.599C855.304 171.74 856.942 182.363 856.817 193.038V222.42L856.529 270.351V295.737C856.211 305.134 857.614 314.511 860.668 323.403C862.831 328.149 864.228 333.206 864.808 338.389C864.751 339.958 864.338 341.494 863.597 342.879C862.857 344.264 861.811 345.461 860.537 346.38C857.833 348.666 854.397 349.903 850.857 349.864ZM832.609 285.389C832.417 274.909 832.417 262.072 832.609 246.876C822.548 243.756 812.041 242.313 801.511 242.606C786.652 241.975 772.003 246.286 759.855 254.867C754.563 259.013 750.191 264.215 747.017 270.141C743.507 277.322 741.837 285.262 742.157 293.248C742.039 297.638 742.841 302.005 744.513 306.066C746.185 310.127 748.689 313.793 751.864 316.827C759.758 323.61 770.014 326.996 780.395 326.246C792.944 326.246 806.917 317.688 822.313 300.571C826.498 296.094 829.962 290.994 832.583 285.454L832.609 285.389Z" fill="#202020"/>
           <path d="M351.2 163.392C351.2 163.392 343.497 174.919 337.275 172.221C331.053 169.523 325.04 157.261 332.035 150.607C339.03 143.952 363.657 134.887 368.713 156.828C369.661 161.504 369.513 166.337 368.281 170.946C367.048 175.555 364.766 179.817 361.611 183.396C358.457 186.975 354.516 189.776 350.099 191.578C345.681 193.38 340.906 194.135 336.148 193.783C320.56 190.115 303.78 175.548 316.918 142.983C329.848 110.929 378.8 121.041 385.206 146.271C386.795 151.784 387.272 157.559 386.607 163.258C385.941 168.958 384.148 174.467 381.332 179.466C378.515 184.465 374.731 188.854 370.201 192.376C365.671 195.897 360.485 198.481 354.946 199.978C350.384 201.056 345.65 201.191 341.035 200.376C336.419 199.56 332.018 197.811 328.101 195.236C324.184 192.661 320.834 189.313 318.256 185.399C315.678 181.484 313.925 177.085 313.106 172.47" fill="#27AAB6"/>
            <path d="M376.863 131.482C381.507 135.188 384.874 140.254 386.491 145.97C388.087 151.932 388.476 158.152 387.635 164.266C386.793 170.38 384.739 176.265 381.592 181.575C375.773 191.355 366.306 198.423 355.275 201.224C350.151 202.498 344.804 202.593 339.637 201.501C334.471 200.41 329.619 198.16 325.448 194.923C321.799 192.315 318.712 189 316.372 185.174C314.031 181.348 312.484 177.09 311.824 172.653C309.955 162.447 311.33 151.911 315.754 142.525C318.601 135.596 323.653 129.799 330.127 126.031C336.601 122.264 344.138 120.735 351.568 121.683C360.815 122.233 369.659 125.66 376.863 131.482ZM325.67 191.74C326.116 192.107 326.561 192.473 326.98 192.827C330.828 195.856 335.321 197.958 340.112 198.972C344.903 199.985 349.863 199.881 354.607 198.669C364.958 196.038 373.839 189.403 379.3 180.225C382.265 175.21 384.2 169.655 384.989 163.883C385.779 158.111 385.408 152.239 383.898 146.612C381.33 140.051 376.844 134.417 371.025 130.445C365.207 126.472 358.326 124.345 351.28 124.343C344.402 123.435 337.417 124.827 331.413 128.303C325.409 131.779 320.723 137.143 318.086 143.56C313.899 152.43 312.576 162.382 314.3 172.038C314.336 172.14 314.362 172.246 314.379 172.353C314.887 174.351 315.621 176.285 316.566 178.117C318.64 181.815 321.486 185.023 324.91 187.523C328.335 190.023 332.258 191.756 336.412 192.604C340.551 193.173 344.766 192.719 348.689 191.282C352.612 189.846 356.124 187.471 358.917 184.365C362.556 180.96 365.25 176.669 366.735 171.911C368.221 167.154 368.447 162.093 367.392 157.223C367.015 154.461 365.874 151.861 364.096 149.715C362.318 147.569 359.975 145.963 357.332 145.079C353.029 144.303 348.607 144.488 344.384 145.621C340.16 146.753 336.239 148.805 332.901 151.629C331.768 152.759 330.94 154.158 330.495 155.695C330.051 157.233 330.004 158.859 330.36 160.419C330.736 162.627 331.593 164.725 332.87 166.566C334.146 168.406 335.812 169.943 337.748 171.069C342.019 172.929 348.084 165.659 350.062 162.711C350.158 162.568 350.281 162.446 350.425 162.351C350.569 162.256 350.73 162.189 350.899 162.156C351.068 162.124 351.242 162.124 351.411 162.159C351.58 162.193 351.74 162.261 351.883 162.358C352.026 162.454 352.148 162.577 352.243 162.721C352.338 162.865 352.404 163.026 352.437 163.195C352.47 163.364 352.469 163.538 352.435 163.707C352.4 163.876 352.333 164.036 352.236 164.178C351.896 164.689 343.84 176.584 336.7 173.479C334.364 172.179 332.349 170.37 330.805 168.186C329.261 166.003 328.227 163.501 327.78 160.864C327.339 158.876 327.412 156.808 327.992 154.855C328.572 152.903 329.639 151.13 331.094 149.704C334.761 146.548 339.094 144.263 343.77 143.02C348.445 141.777 353.342 141.607 358.092 142.525C361.161 143.554 363.887 145.411 365.967 147.891C368.048 150.372 369.402 153.379 369.881 156.581C371.008 161.885 370.757 167.391 369.152 172.571C367.547 177.751 364.641 182.434 360.712 186.173C357.599 189.592 353.695 192.194 349.342 193.752C344.988 195.31 340.319 195.775 335.744 195.107C331.204 194.056 326.908 192.144 323.09 189.473C323.968 190.246 324.793 190.993 325.67 191.74Z" fill="#166569"/>
            <path d="M396.71 246.511C396.71 246.511 394.378 232.835 400.757 230.53C407.137 228.224 419.922 232.993 419.398 242.634C418.874 252.275 407.229 275.789 388.483 263.305C384.584 260.557 381.373 256.943 379.103 252.747C376.833 248.552 375.564 243.888 375.397 239.12C375.229 234.352 376.167 229.61 378.137 225.266C380.108 220.921 383.057 217.091 386.754 214.076C400.6 206.033 422.804 205.103 435.628 237.786C448.243 269.972 405.735 296.237 383.728 282.325C378.794 279.407 374.49 275.538 371.066 270.941C367.642 266.345 365.166 261.114 363.782 255.551C362.399 249.989 362.135 244.206 363.007 238.541C363.879 232.876 365.868 227.441 368.86 222.552C371.435 218.637 374.782 215.288 378.696 212.711C382.61 210.133 387.009 208.381 391.623 207.562C396.237 206.743 400.969 206.874 405.531 207.946C410.093 209.019 414.388 211.012 418.153 213.801" fill="#DA0032"/>
            <path d="M397.882 287.407C392.658 287.53 387.506 286.168 383.027 283.477C377.76 280.245 373.192 275.992 369.593 270.969C365.993 265.945 363.435 260.252 362.068 254.226C360.837 248.729 360.701 243.043 361.667 237.494C362.634 231.944 364.684 226.64 367.701 221.883C370.545 217.433 374.364 213.69 378.869 210.934C383.374 208.179 388.446 206.485 393.703 205.98C398.141 205.371 402.656 205.659 406.981 206.826C411.306 207.994 415.352 210.018 418.88 212.779C427.276 218.903 433.539 227.508 436.787 237.38C439.482 244.37 439.796 252.055 437.681 259.243C435.566 266.43 431.141 272.719 425.089 277.137C417.451 283.552 407.854 287.174 397.882 287.407ZM397.987 208.325C396.674 208.328 395.362 208.398 394.057 208.535C389.182 208.981 384.476 210.542 380.301 213.097C376.126 215.652 372.595 219.134 369.98 223.272C364.279 232.294 362.394 243.212 364.74 253.624C366.027 259.307 368.436 264.675 371.826 269.415C375.216 274.155 379.519 278.17 384.481 281.224C390.853 284.244 397.988 285.271 404.952 284.17C411.917 283.07 418.388 279.892 423.518 275.054C429.143 270.992 433.266 265.181 435.245 258.53C437.224 251.879 436.946 244.761 434.456 238.284C431.414 228.957 425.539 220.811 417.649 214.98C417.544 214.933 417.447 214.871 417.361 214.796C415.622 213.692 413.763 212.792 411.82 212.111C407.773 210.854 403.503 210.48 399.3 211.016C395.096 211.552 391.057 212.984 387.455 215.216C384.056 217.645 381.304 220.87 379.439 224.608C377.573 228.346 376.651 232.483 376.753 236.659C376.448 241.633 377.437 246.601 379.625 251.078C381.813 255.555 385.124 259.388 389.236 262.203C391.402 263.955 394.016 265.064 396.781 265.405C399.546 265.745 402.351 265.303 404.877 264.129C408.539 261.735 411.625 258.56 413.915 254.832C416.205 251.105 417.641 246.915 418.121 242.567C418.172 240.965 417.813 239.377 417.077 237.953C416.341 236.529 415.252 235.317 413.916 234.432C412.123 233.093 410.058 232.164 407.867 231.711C405.676 231.258 403.412 231.293 401.235 231.812C396.86 233.397 397.437 242.842 398.026 246.34C398.087 246.68 398.011 247.031 397.815 247.315C397.619 247.6 397.318 247.796 396.978 247.86C396.636 247.917 396.285 247.835 396.003 247.634C395.721 247.432 395.529 247.127 395.472 246.785C395.367 246.183 393.035 231.996 400.371 229.35C402.96 228.669 405.67 228.589 408.294 229.116C410.919 229.642 413.388 230.762 415.514 232.389C417.197 233.533 418.562 235.087 419.479 236.905C420.395 238.722 420.834 240.743 420.754 242.777C420.254 247.59 418.673 252.227 416.128 256.342C413.583 260.457 410.139 263.943 406.056 266.539C403.115 267.915 399.851 268.448 396.625 268.081C393.399 267.713 390.338 266.458 387.782 264.456C383.318 261.372 379.718 257.195 377.327 252.324C374.935 247.454 373.831 242.052 374.119 236.634C374.041 232.021 375.096 227.459 377.19 223.348C379.284 219.237 382.354 215.703 386.132 213.054C390.16 210.686 394.608 209.12 399.231 208.443L397.987 208.325Z" fill="#760A1B"/>
            <path d="M328.31 307.41C328.31 307.41 341.488 311.732 340.558 318.452C339.628 325.172 329.436 334.263 321.144 329.298C312.853 324.334 297.5 303.1 317.293 292.306C321.544 290.137 326.239 288.983 331.01 288.932C335.782 288.881 340.5 289.935 344.796 292.012C349.092 294.089 352.849 297.132 355.772 300.903C358.696 304.674 360.707 309.071 361.648 313.749C362.303 329.757 352.767 349.839 317.856 345.922C283.483 342.071 280.091 292.214 302.674 279.233C307.557 276.227 312.99 274.223 318.655 273.337C324.32 272.451 330.105 272.701 335.673 274.072C341.241 275.444 346.48 277.909 351.086 281.325C355.691 284.741 359.571 289.039 362.499 293.969C364.763 298.076 366.166 302.6 366.62 307.267C367.075 311.934 366.573 316.644 365.145 321.11C363.716 325.576 361.391 329.703 358.312 333.24C355.233 336.776 351.465 339.647 347.239 341.677" fill="#4BA46C"/>
           <path d="M328.043 271.675C331.292 271.839 334.512 272.361 337.645 273.233C343.088 274.704 348.186 277.236 352.648 280.682C357.111 284.128 360.849 288.421 363.648 293.315C366.258 297.908 367.788 303.035 368.124 308.307C368.46 313.579 367.592 318.858 365.587 323.745C364.054 327.955 361.692 331.814 358.641 335.095C355.59 338.375 351.912 341.011 347.824 342.844C338.485 347.415 327.947 348.94 317.695 347.206C310.252 346.327 303.306 343.019 297.935 337.792C292.564 332.565 289.067 325.711 287.985 318.295C285.989 310.958 286.26 303.19 288.762 296.01C291.263 288.83 295.879 282.575 302.002 278.067C309.884 273.469 318.928 271.25 328.043 271.675ZM360.936 327.373C361.779 325.893 362.519 324.357 363.15 322.776C365.031 318.256 365.847 313.363 365.536 308.478C365.224 303.592 363.794 298.844 361.355 294.599C356.04 285.332 347.262 278.556 336.951 275.761C331.324 274.246 325.45 273.872 319.675 274.659C313.901 275.447 308.342 277.38 303.325 280.346C297.677 284.572 293.438 290.404 291.161 297.08C288.885 303.755 288.677 310.963 290.566 317.759C291.533 324.633 294.748 330.994 299.71 335.85C304.672 340.705 311.102 343.781 317.996 344.599C327.658 346.274 337.602 344.901 346.448 340.669C346.541 340.604 346.643 340.552 346.75 340.512C348.539 339.489 350.205 338.262 351.714 336.857C354.717 333.866 357.041 330.263 358.529 326.294C360.016 322.325 360.632 318.083 360.334 313.855C359.769 309.714 358.2 305.775 355.764 302.38C353.328 298.985 350.098 296.237 346.357 294.376C342.096 291.783 337.236 290.341 332.251 290.189C327.266 290.038 322.328 291.182 317.918 293.511C315.358 294.612 313.158 296.408 311.567 298.695C309.977 300.983 309.059 303.671 308.918 306.453C309.327 310.81 310.695 315.023 312.923 318.789C315.152 322.555 318.186 325.782 321.808 328.238C323.203 329.032 324.777 329.457 326.381 329.473C327.986 329.489 329.568 329.095 330.978 328.329C333.004 327.373 334.796 325.984 336.227 324.259C337.657 322.534 338.692 320.516 339.257 318.348C339.899 313.737 331.279 309.846 327.899 308.733C327.573 308.625 327.301 308.392 327.144 308.086C326.987 307.78 326.958 307.424 327.061 307.095C327.169 306.765 327.403 306.492 327.713 306.335C328.022 306.178 328.382 306.149 328.712 306.257C329.288 306.44 342.925 311.012 341.811 318.728C341.191 321.329 339.992 323.757 338.305 325.832C336.618 327.907 334.485 329.575 332.065 330.713C330.268 331.67 328.257 332.153 326.222 332.117C324.186 332.08 322.194 331.525 320.433 330.504C316.407 327.818 313.042 324.256 310.589 320.084C308.137 315.912 306.661 311.238 306.272 306.414C306.425 303.171 307.474 300.033 309.304 297.351C311.133 294.668 313.671 292.546 316.634 291.219C321.444 288.708 326.817 287.472 332.24 287.628C337.663 287.784 342.957 289.327 347.614 292.11C351.741 294.192 355.294 297.255 357.962 301.03C360.629 304.805 362.33 309.177 362.914 313.763C363.128 318.384 362.457 323.004 360.936 327.373Z" fill="#204F30"/>
            <path d="M233.051 265.621C233.051 265.621 233.955 251.775 240.688 251.016C247.421 250.256 258.765 257.854 256.014 267.115C253.263 276.376 236.509 296.549 221.156 280.057C218 276.48 215.715 272.222 214.479 267.615C213.242 263.009 213.089 258.178 214.03 253.502C214.971 248.826 216.982 244.431 219.905 240.662C222.827 236.892 226.582 233.849 230.876 231.773C246.216 227.148 268.026 231.393 272.925 266.159C277.746 300.375 230.3 316.094 212.131 297.453C208.01 293.473 204.721 288.714 202.456 283.452C200.191 278.19 198.994 272.529 198.936 266.801C198.877 261.072 199.958 255.389 202.116 250.082C204.273 244.774 207.463 239.949 211.502 235.885C214.914 232.674 218.945 230.193 223.349 228.593C227.753 226.993 232.438 226.307 237.115 226.58C241.793 226.852 246.366 228.076 250.555 230.176C254.744 232.276 258.46 235.209 261.477 238.794" fill="#7E86C0"/>
            <path d="M233.576 306.676C229.482 306.839 225.396 306.188 221.555 304.76C217.714 303.332 214.195 301.156 211.202 298.358C206.836 293.992 203.388 288.796 201.06 283.078C198.731 277.359 197.57 271.233 197.644 265.059C197.802 253.694 202.467 242.856 210.613 234.93C214.414 231.263 218.999 228.507 224.02 226.869C229.041 225.23 234.369 224.753 239.602 225.472C244.059 225.906 248.385 227.231 252.321 229.369C256.256 231.507 259.722 234.413 262.513 237.917C269.286 245.808 273.41 255.628 274.302 265.989C275.302 273.413 273.826 280.959 270.104 287.459C266.381 293.96 260.619 299.052 253.71 301.947C247.446 305.036 240.56 306.654 233.576 306.676ZM234.729 227.764C226.403 227.728 218.399 230.982 212.46 236.816C208.671 240.506 205.648 244.907 203.562 249.766C201.476 254.626 200.368 259.849 200.303 265.137C200.237 270.968 201.337 276.753 203.539 282.152C205.742 287.551 209.002 292.456 213.128 296.576C218.625 300.987 225.326 303.637 232.354 304.179C239.381 304.721 246.408 303.131 252.518 299.615C258.929 296.965 264.285 292.269 267.749 286.258C271.213 280.246 272.591 273.258 271.669 266.381C270.863 256.609 267.035 247.329 260.718 239.829C260.63 239.755 260.551 239.672 260.482 239.58C259.049 238.092 257.449 236.773 255.714 235.651C252.072 233.484 248.005 232.128 243.791 231.676C239.577 231.224 235.316 231.686 231.297 233.031C227.433 234.603 224.012 237.096 221.332 240.292C218.651 243.488 216.793 247.291 215.918 251.369C214.467 256.14 214.279 261.207 215.372 266.072C216.464 270.937 218.801 275.436 222.153 279.127C223.855 281.331 226.141 283.013 228.75 283.983C231.359 284.953 234.189 285.173 236.916 284.616C241.031 283.133 244.766 280.759 247.855 277.664C250.944 274.568 253.31 270.827 254.784 266.709C255.205 265.162 255.223 263.533 254.838 261.976C254.453 260.419 253.677 258.987 252.583 257.814C251.16 256.083 249.37 254.689 247.343 253.733C245.315 252.777 243.101 252.283 240.859 252.286C236.222 252.81 234.611 262.125 234.375 265.675C234.358 266.011 234.213 266.327 233.969 266.559C233.725 266.791 233.401 266.919 233.065 266.919C232.729 266.902 232.412 266.756 232.181 266.513C231.949 266.269 231.82 265.945 231.821 265.609C231.821 264.993 232.882 250.663 240.623 249.772C243.299 249.703 245.955 250.247 248.387 251.365C250.819 252.482 252.963 254.141 254.653 256.216C256.027 257.721 256.995 259.551 257.468 261.533C257.94 263.515 257.9 265.585 257.352 267.548C255.745 272.102 253.13 276.234 249.703 279.637C246.276 283.039 242.124 285.624 237.558 287.197C234.379 287.85 231.081 287.611 228.029 286.506C224.978 285.4 222.291 283.472 220.267 280.935C216.64 276.902 214.106 272.007 212.907 266.717C211.707 261.427 211.883 255.918 213.416 250.715C214.402 246.2 216.481 241.996 219.471 238.472C222.461 234.948 226.269 232.212 230.563 230.503C235.019 229.129 239.698 228.631 244.344 229.035C242.696 228.59 241.02 228.257 239.327 228.039C237.819 227.844 236.301 227.744 234.781 227.739L234.729 227.764Z" fill="#141C4F"/>
            <path d="M249.921 173.531C249.921 173.531 243.555 161.205 248.938 157.079C254.322 152.952 267.946 153.607 270.369 162.96C272.792 172.313 268.837 198.237 247.183 192.028C242.635 190.592 238.48 188.124 235.045 184.816C231.61 181.507 228.987 177.449 227.382 172.957C225.777 168.466 225.233 163.664 225.794 158.927C226.354 154.191 228.004 149.648 230.613 145.656C241.367 133.788 262.234 126.164 284.32 153.424C306.118 180.252 273.566 218.188 248.388 211.586C242.807 210.302 237.536 207.922 232.882 204.584C228.228 201.246 224.284 197.017 221.278 192.142C218.273 187.267 216.266 181.843 215.375 176.186C214.483 170.528 214.725 164.751 216.085 159.188C217.35 154.675 219.522 150.467 222.469 146.822C225.416 143.178 229.075 140.173 233.224 137.991C237.372 135.81 241.922 134.498 246.595 134.135C251.268 133.773 255.965 134.368 260.401 135.884" fill="#F88C07"/>
            <path d="M215.568 182.95C212.992 175.155 212.751 166.778 214.874 158.848C216.235 153.748 218.736 149.023 222.19 145.032C225.644 141.04 229.96 137.885 234.811 135.805C238.855 133.876 243.245 132.779 247.72 132.579C252.196 132.379 256.666 133.079 260.866 134.64C270.718 137.933 279.292 144.227 285.388 152.639C290.072 158.483 292.699 165.707 292.862 173.195C293.026 180.683 290.716 188.016 286.292 194.059C282.571 200.685 276.932 206.03 270.117 209.392C263.302 212.753 255.629 213.975 248.107 212.896C242.112 211.409 236.474 208.74 231.525 205.044C226.576 201.348 222.416 196.7 219.288 191.373C217.757 188.703 216.51 185.88 215.568 182.95ZM240.68 136.46C239.04 136.934 237.434 137.516 235.872 138.202C231.363 140.105 227.352 143.019 224.15 146.719C220.947 150.419 218.638 154.807 217.402 159.542C214.697 169.873 216.205 180.856 221.594 190.076C224.544 195.099 228.468 199.481 233.136 202.966C237.804 206.45 243.121 208.967 248.775 210.368C255.77 211.325 262.891 210.145 269.204 206.982C275.516 203.819 280.724 198.821 284.144 192.644C288.266 187.066 290.429 180.281 290.294 173.346C290.158 166.411 287.734 159.715 283.397 154.302C277.661 146.349 269.595 140.375 260.316 137.207C260.212 137.194 260.111 137.167 260.014 137.129C258.021 136.595 255.973 136.296 253.91 136.238C249.674 136.266 245.492 137.205 241.65 138.991C237.808 140.776 234.395 143.366 231.641 146.586C229.137 149.931 227.491 153.839 226.847 157.968C226.203 162.097 226.58 166.321 227.947 170.27C229.165 175.102 231.616 179.537 235.06 183.139C238.504 186.741 242.823 189.389 247.596 190.823C250.191 191.834 253.019 192.097 255.756 191.58C258.494 191.064 261.031 189.789 263.08 187.902C265.843 184.51 267.821 180.55 268.872 176.303C269.923 172.056 270.021 167.629 269.158 163.34C268.732 161.794 267.913 160.385 266.781 159.249C265.65 158.113 264.244 157.289 262.7 156.856C260.585 156.113 258.332 155.846 256.102 156.073C253.872 156.299 251.719 157.014 249.797 158.167C246.103 161.009 249.522 169.825 251.107 172.982C251.186 173.135 251.235 173.302 251.249 173.473C251.264 173.645 251.245 173.818 251.192 173.983C251.14 174.147 251.056 174.3 250.944 174.431C250.833 174.563 250.697 174.671 250.543 174.75C250.39 174.83 250.223 174.878 250.051 174.893C249.879 174.907 249.707 174.888 249.542 174.836C249.378 174.784 249.225 174.699 249.094 174.588C248.962 174.477 248.854 174.34 248.775 174.187C248.5 173.636 241.976 160.839 248.159 156.097C250.416 154.661 252.972 153.759 255.63 153.462C258.289 153.165 260.98 153.479 263.499 154.381C265.452 154.959 267.227 156.024 268.654 157.477C270.082 158.929 271.116 160.722 271.66 162.685C272.645 167.422 272.546 172.32 271.371 177.014C270.196 181.707 267.975 186.075 264.874 189.789C262.491 191.992 259.543 193.492 256.359 194.121C253.175 194.75 249.878 194.483 246.836 193.351C241.635 191.796 236.924 188.921 233.164 185.004C229.404 181.088 226.722 176.264 225.379 171.004C223.887 166.622 223.497 161.94 224.241 157.371C224.986 152.802 226.843 148.486 229.65 144.805C232.759 141.344 236.503 138.511 240.68 136.46Z" fill="#7C4318"/>
          </svg>
          </div>
          <div>
          <img src="${qrDataUrl}" alt="Barcode" style="display: block; margin-right: 2px" />
          </div>
        </div>
        <div class="address-details" style="display: flex;">
          <div style="flex: 2; border-right: 1px solid black; display: flex; font-size: 10px; padding-bottom: 3px">
            <div class="" style="flex: 1; margin-top: 3px;">
              <p class="address-inline">From:</p>
              <p class="address-inline">Oorla</p>
              <p class="address-inline">Fouvi Technology Private Limited</p>
              <p class="address-inline">15-2, 15-3, Housing Board Road</p>
              <p class="address-inline">Kovaipudur</p>
              <p class="address-inline">Coimbatore - 641042</p>
              <p class="address-inline">9043338812</p>
            </div>
          </div>
          <div style="flex: 1; margin-left: 3px; font-size: 10px; margin-top: 4px;">
          <p class="address-inline">Ship Date: shipDate}</p>
          <p class="address-inline">Inv No: order.name}</p>
          <p class="address-inline">Inv Date: invoiceDate}</p>
          </div>
        </div>
        <div class="shipping-address" style="display: flex;">
          <div style="font-size: 12px; font-weight: 800; flex: 2; margin-left: 1px; margin-top: 5px; margin-bottom: 5px">
            <p class="address-inline" style="margin-bottom: 5px">Ship To:</p>
            <div style="display: flex; flex-direction: column">
             <p class="address-inline">.name}</p>
             <p class="address-inline">.address1}</p>
             <p class="address-inline">.address2 || ""}</p>
             <p class="address-inline">.city}</p>
             <p class="address-inline">.province}</p>
             <p class="address-inline">.country} - .zip}</p>
             <p class="address-inline">Mobile No: .phone}</p>
             </div>
          </div>
        </div>
        <div class="bill-value" style="display: flex;">
        <p style="flex: 1; font-size: 12px; font-weight: 800">AWB No. wbNumber}</p>
        <p style="flex: 1; font-size: 12px; font-weight: 900; text-align: right">Dest.Pin:shippingAddress.zip}</p>
      </div>
        <div class="barcode-details" style="flex;">
        <div style="margin: 10px">
          <p style="text-align: center; font-size: 14px; margin: 4px 0">DELHIVERY</p>
           <img src="${barcodeDataUrl}" alt="Barcode" style="display: block;
           margin: 0 auto;
           width: 60%;" />
           </div>
        </div>
        <div class="bill-value" style="display: flex;">
        <p style="flex: 1; font-size: 12px; font-weight: 800">$Ref.No: ${orderId}</p>
        <p style="flex: 1; font-size: 12px; font-weight: 900; text-align: right">Invoice Cost: invoiceCost}</p>
      </div>
        <div class="footer">
          <p style="font-size: 10px; margin-left: 5px;">Order Id: <br />${orderId}</p>
          <p style="font-size: 10px">Weight: totalWeight} kg</p>
          <p style="font-size: 10px; margin-right: 5px">date}</p>
        </div>
      </div>
    </section>
  </body>
</html>
  `;
  let file = { content: html };
  let emptyPDF = await createEmptyPDF(shippingLabelFilePath)
    .then((res) => {
      return res;
    })
    .catch((error) => {
      console.error("PDF creation failed:", error);
      return false;
    });
  if (!emptyPDF) {
    return {};
  }
  let isPdfGenerated = await html_to_pdf
    .generatePdf(file, {
      format: "A6",
      path: shippingLabelFilePath,
      printBackground: true,
    })
    .then((pdfBuffer) => {
      // console.log("PDF Buffer:-", pdfBuffer);
      return true;
    })
    .catch((error) => {
      console.log("error in generating pdf", error);
      return false;
    });
  if (!isPdfGenerated) return isPdfGenerated;
  // let isFileUploaded = await uploadToS3Bucket(shippingLabelFilePath);
  // await deleteLocalFile(shippingLabelFilePath);
  return {
    isCreated: isPdfGenerated,
    shippingLabelFilePath: shippingLabelFilePath,
  };
}
async function generateBarcode(awbNumber, retryCount = 0) {
  try {
    let awbNuber = 6625910019670;
    let waybill = awbNuber.toString();
    return new Promise((resolve, reject) => {
      setTimeout(async () => {
        bwipjs.toBuffer(
          {
            bcid: "code128",
            text: waybill,
            scale: 3,
            height: 8,
            includetext: true,
            textxalign: "center",
          },
          function (err, png) {
            if (err) {
              console.log(err);
              if (retryCount >= 5) {
                // Maximum of 5 retries
                console.log("generate awb retry");
                return resolve({
                  error: "Max retries reached. Unable to generate barcode.",
                });
              }
              return resolve(generateBarcode(awbNumber, retryCount + 1));
            } else {
              const base64String = png.toString("base64");
              const dataUrl = `data:image/png;base64,${base64String}`;
              resolve(dataUrl);
            }
          }
        );
      }, 300);
    });
  } catch (error) {
    console.error(error);
  }
}
async function createQRCode(orderId, width = 55, height = 40) {
  try {
    let orderNumber = orderId.toString();
    let qrGenerated = await QRCode.toDataURL(orderNumber, { width, height });
    return qrGenerated;
  } catch (err) {
    console.error(err);
  }
}
const createEmptyPDF = async (filePath) => {
  const pdfContent = Buffer.from("%PDF-1.4\n");
  console.log("create empty pdf method called");

  return new Promise((resolve, reject) => {
    fs.writeFile(filePath, pdfContent, (err) => {
      if (err) {
        console.error("Error creating PDF file:", err);
        reject(err);
      } else {
        resolve(true);
      }
    });
  });
};
module.exports = { createShipment };
